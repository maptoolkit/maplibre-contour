<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Terrain-Split Contours Test</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://unpkg.com/maplibre-gl@5.6.0/dist/maplibre-gl.js"></script>
    <script src="dist/index.min.js"></script>
    <link href="https://unpkg.com/maplibre-gl@5.6.0/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
      body { margin: 0; padding: 0; }
      #map { position: absolute; top: 0; bottom: 0; width: 100%; }
      #info {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        font-family: Arial, sans-serif;
        font-size: 12px;
        max-width: 300px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      #info h3 { margin: 0 0 10px 0; font-size: 14px; }
      .legend { margin-top: 10px; }
      .legend-item { display: flex; align-items: center; margin: 5px 0; }
      .legend-color { width: 30px; height: 3px; margin-right: 8px; }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="info">
      <h3>Terrain-Split Contours</h3>
      <p>Using AWS Terrarium DEM + MapToolkit Vector Tiles</p>
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color" style="background: #8B4513; height: 2px;"></div>
          <span>Normal terrain</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #4A90E2; height: 2px;"></div>
          <span>Glacier/Ice</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #696969; height: 2px;"></div>
          <span>Rock/Scree</span>
        </div>
      </div>
    </div>
    <script>
      const API_KEY = "toursprung";
      
      console.log('Starting terrain-split contours test...');
      
      // Create DEM source with terrain splitting enabled
      var demSource = new mlcontour.DemSource({
        url: "https://data.maptoolkit.net/maptoolkit/terrainrgb/{z}/{x}/{y}.webp?api_key=iib",
        encoding: "terrarium",
        maxzoom: 16,
        worker: true,
        cacheSize: 100,
        
        // Enable terrain-based contour splitting
        vectorTileUrl: `https://data.maptoolkit.net/maptoolkit/mtk_vtc1/{z}/{x}/{y}.pbf?api_key=iib`,
        vectorSourceLayer: 'natural',
        vectorTerrainTypes: {
          glacier: ['ice'],      // type=ice for glaciers
          rock: ['rock']         // type=rock for rock/scree
        }
      });
      
      demSource.setupMaplibre(maplibregl);
      
      var map = new maplibregl.Map({
        container: "map",
        zoom: 12.5,
        center: [7.658, 45.977], // Mont Blanc area - has glaciers and rock
        hash: true,
        style: {
          version: 8,
          glyphs: "https://static.maptoolkit.net/fonts/{fontstack}/{range}.pbf",
          sources: {
            mtk: {
                type: "vector",
                tiles: [demSource.vectorTileProtocolUrl],
                minzoom: 0,
                maxzoom: 14
            },
            dem: {
              type: "raster-dem",
              encoding: "terrarium",
              tiles: [demSource.sharedDemProtocolUrl],
              maxzoom: 13,
              tileSize: 256,
            },
            contours: {
              type: "vector",
              tiles: [
                demSource.contourProtocolUrl({
                  multiplier: 1,
                  thresholds: {
                    11: [200, 1000],
                    12: [100, 500, 1000],
                    13: [50, 200, 500, 1000],
                    14: [20, 100, 500, 1000],
                  },
                  elevationKey: "ele",
                  levelKey: "level",
                  contourLayer: "contours",
                  splitMode: "classic"
                }),
              ],
              maxzoom: 15,
            },
          },
          layers: [
            {
                id: "nature_glacier",
                source: "mtk",
                "source-layer": "natural",
                type: "fill",
                filter: ["==", ["get", "type"], "ice"],
                minzoom: 4,
                maxzoom: 22,
                layout: {"visibility": "visible"},
                paint: {
                    "fill-color": "hsla(210, 50%, 80%, 0.5)",
                    "fill-outline-color": "hsla(210, 50%, 60%, 1)"
                }
            },
            {
                id: "nature_rock",
                source: "mtk",
                "source-layer": "natural",
                type: "fill",
                filter: ["==", ["get", "type"], "rock"],
                minzoom: 4,
                maxzoom: 22,
                layout: {"visibility": "visible"},
                paint: {
                    "fill-color": "hsla(0, 10%, 80%, 0.5)",
                    "fill-outline-color": "hsla(0, 10%, 60%, 1)"
                }
            },
            {
              id: "hills",
              type: "hillshade",
              source: "dem",
              paint: { 
                "hillshade-exaggeration": 0.1,
                "hillshade-shadow-color": "#000000"
              },
              layout: {"visibility": "visible"}
            },
            {
                id: "color-relief",
                type: "color-relief",
                source: "dem",
                paint: {
                    "color-relief-opacity": 0.4,
                    "color-relief-color": [
                        'interpolate',
                        ['linear'],
                        ['elevation'],
                        400, 'black',
                        3500, 'white'
                    ]
                },
                layout: {"visibility": "visible"}
            },
            // Rock/scree contours (gray)
            {
              "id": "relief_contour_offset",
              "source": "contours",
              "source-layer": "contours",
              "type": "line",
              "filter": [
                "!=",
                [
                  "get",
                  "ele"
                ],
                0
              ],
              "minzoom": 12,
              "maxzoom": 22,
              "layout": {
                "line-cap": "round",
                "line-join": "round",
                "visibility": "visible"
              },
              "paint": {
                "line-color": "hsla(33.75, 40%, 100%, 0.5)",
                "line-width": [
                  "interpolate",
                  [
                    "exponential",
                    1.2
                  ],
                  [
                    "zoom"
                  ],
                  11,
                  [
                    "case",
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          500,
                          1000
                        ]
                      ]
                    ],
                    0.51,
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          100,
                          200
                        ]
                      ]
                    ],
                    0.31,
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          0,
                          10,
                          20,
                          50
                        ]
                      ]
                    ],
                    0.16,
                    0
                  ],
                  16,
                  [
                    "case",
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          500,
                          1000
                        ]
                      ]
                    ],
                    2.54,
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          100,
                          200
                        ]
                      ]
                    ],
                    1.53,
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          0,
                          10,
                          20,
                          50
                        ]
                      ]
                    ],
                    0.78,
                    0
                  ]
                ],
                "line-offset": [
                  "interpolate",
                  [
                    "exponential",
                    1.2
                  ],
                  [
                    "zoom"
                  ],
                  11,
                  [
                    "case",
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          500,
                          1000
                        ]
                      ]
                    ],
                    0.28,
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          100,
                          200
                        ]
                      ]
                    ],
                    0.17,
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          0,
                          10,
                          20,
                          50
                        ]
                      ]
                    ],
                    0.09,
                    0
                  ],
                  16,
                  [
                    "case",
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          500,
                          1000
                        ]
                      ]
                    ],
                    1.41,
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          100,
                          200
                        ]
                      ]
                    ],
                    0.85,
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          0,
                          10,
                          20,
                          50
                        ]
                      ]
                    ],
                    0.43,
                    0
                  ]
                ]
              },
              "metadata": {
                "maptoolkit:category": "Contour Lines"
              }
            }, // relief_contour_offset 
            {
              "id": "relief_contour_multicolored",
              "source": "contours",
              "source-layer": "contours",
              "type": "line",
              "filter": [
                "!=",
                [
                  "get",
                  "ele"
                ],
                0
              ],
              "minzoom": 11,
              "maxzoom": 22,
              "layout": {
                "line-cap": "round",
                "line-join": "round",
                "visibility": "visible"
              },
              "paint": {
                "line-color": [
                  "case",
                  [
                    "==",
                    [
                      "get",
                      "terrain_type"
                    ],
                    "normal"
                  ],
                  "hsla(33.75, 40%, 45%, 0.7)",
                  [
                    "==",
                    [
                      "get",
                      "terrain_type"
                    ],
                    "glacier"
                  ],
                  "hsla(191.25, 60%, 45%, 0.7)",
                  "hsla(78.75, 0%, 45%, 0.7)"
                ],
                "line-width": [
                  "interpolate",
                  [
                    "exponential",
                    1.2
                  ],
                  [
                    "zoom"
                  ],
                  11,
                  [
                    "case",
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          500,
                          1000
                        ]
                      ]
                    ],
                    0.51,
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          100,
                          200
                        ]
                      ]
                    ],
                    0.31,
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          0,
                          10,
                          20,
                          50
                        ]
                      ]
                    ],
                    0.16,
                    0
                  ],
                  16,
                  [
                    "case",
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          500,
                          1000
                        ]
                      ]
                    ],
                    2.54,
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          100,
                          200
                        ]
                      ]
                    ],
                    1.53,
                    [
                      "in",
                      [
                        "get",
                        "divisor"
                      ],
                      [
                        "literal",
                        [
                          0,
                          10,
                          20,
                          50
                        ]
                      ]
                    ],
                    0.78,
                    0
                  ]
                ]
              },
              "metadata": {
                "maptoolkit:category": "Contour Lines"
              }
            }, // relief_contour_multicolored 
            {
              "id": "relief_contour_multicolored_label",
              "source": "contours",
              "source-layer": "contours",
              "type": "symbol",
              "filter": [
                "in",
                [
                  "get",
                  "divisor"
                ],
                [
                  "literal",
                  [
                    100,
                    500,
                    1000
                  ]
                ]
              ],
              "minzoom": 11,
              "maxzoom": 22,
              "layout": {
                "symbol-placement": "line",
                "symbol-spacing": [
                  "interpolate",
                  [
                    "linear"
                  ],
                  [
                    "zoom"
                  ],
                  10,
                  100,
                  19,
                  500
                ],
                "text-field": [
                  "get",
                  "ele"
                ],
                "text-font": ["Noto Sans Bold"],
                "text-letter-spacing": 0.1,
                "text-pitch-alignment": "viewport",
                "text-max-angle": 90,
                "text-size": [
                  "interpolate",
                  [
                    "linear"
                  ],
                  [
                    "zoom"
                  ],
                  9,
                  5.72,
                  14,
                  [
                    "case",
                    [
                      ">",
                      [
                        "get",
                        "divisor"
                      ],
                      100
                    ],
                    9.69,
                    8.72
                  ],
                  16,
                  [
                    "case",
                    [
                      ">",
                      [
                        "get",
                        "divisor"
                      ],
                      100
                    ],
                    11.96,
                    10.76
                  ]
                ],
                "text-padding": [
                  "interpolate",
                  [
                    "linear"
                  ],
                  [
                    "zoom"
                  ],
                  6,
                  9,
                  16,
                  8
                ],
                "visibility": "visible"
              },
              "paint": {
                "text-color": [
                  "case",
                  [
                    "==",
                    [
                      "get",
                      "terrain_type"
                    ],
                    "normal"
                  ],
                  "hsla(33.75, 40%, 30%, 0.5)",
                  [
                    "==",
                    [
                      "get",
                      "terrain_type"
                    ],
                    "glacier"
                  ],
                  "hsla(191.25, 60%, 30%, 0.5)",
                  "hsla(78.75, 0%, 30%, 0.5)"
                ],
                "text-halo-color": [
                  "case",
                  [
                    "==",
                    [
                      "get",
                      "terrain_type"
                    ],
                    "normal"
                  ],
                  "hsla(33.75, 40%, 100%, 0.5)",
                  [
                    "==",
                    [
                      "get",
                      "terrain_type"
                    ],
                    "glacier"
                  ],
                  "hsla(191.25, 60%, 100%, 0.5)",
                  "hsla(78.75, 0%, 100%, 0.5)"
                ],
                "text-halo-width": 1,
                "text-halo-blur": 0.5
              },
              "metadata": {
                "maptoolkit:category": "Contour Lines"
              }
            } // relief_contour_multicolored_label
          ],
        },
      });
      
      // Add tile boundary visualization
      map.on('load', () => {
        console.log('Map loaded!');
        map.showTileBoundaries = false;
      });
      
      map.addControl(new maplibregl.NavigationControl());
      map.addControl(new maplibregl.ScaleControl({ maxWidth: 200, unit: 'metric' }));
    </script>
  </body>
</html>
