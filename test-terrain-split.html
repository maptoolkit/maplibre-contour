<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Terrain-Split Contours Test</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://unpkg.com/maplibre-gl@4.6.0/dist/maplibre-gl.js"></script>
    <script src="dist/index.min.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.6.0/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
      body { margin: 0; padding: 0; }
      #map { position: absolute; top: 0; bottom: 0; width: 100%; }
      #info {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        font-family: Arial, sans-serif;
        font-size: 12px;
        max-width: 300px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      #info h3 { margin: 0 0 10px 0; font-size: 14px; }
      .legend { margin-top: 10px; }
      .legend-item { display: flex; align-items: center; margin: 5px 0; }
      .legend-color { width: 30px; height: 3px; margin-right: 8px; }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="info">
      <h3>Terrain-Split Contours</h3>
      <p>Using AWS Terrarium DEM + MapToolkit Vector Tiles</p>
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color" style="background: #8B4513; height: 2px;"></div>
          <span>Normal terrain</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #4A90E2; height: 2px;"></div>
          <span>Glacier/Ice</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #696969; height: 2px;"></div>
          <span>Rock/Scree</span>
        </div>
      </div>
    </div>
    <script>
      const API_KEY = "toursprung";
      
      console.log('Starting terrain-split contours test...');
      
      // Create DEM source with terrain splitting enabled
      var demSource = new mlcontour.DemSource({
        url: "https://elevation-tiles-prod.s3.amazonaws.com/terrarium/{z}/{x}/{y}.png",
        encoding: "terrarium",
        maxzoom: 13,
        worker: true, // Vector tile splitting only works in local mode (not worker mode yet)
        cacheSize: 100,
        
        // Enable terrain-based contour splitting
        vectorTileUrl: `https://vtc-cdn.maptoolkit.net/mtk-contours-bathymetry/{z}/{x}/{y}.pbf?api_key=${API_KEY}`,
        vectorSourceLayer: 'natural',
        vectorTerrainTypes: {
          glacier: ['ice'],      // type=ice for glaciers
          rock: ['rock']         // type=rock for rock/scree
        }
      });
      
      demSource.setupMaplibre(maplibregl);
      
      var map = new maplibregl.Map({
        container: "map",
        zoom: 12.5,
        center: [7.658, 45.977], // Mont Blanc area - has glaciers and rock
        hash: true,
        style: {
          version: 8,
          glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
          sources: {
            mtk: {
                type: "vector",
                tiles: [demSource.vectorTileProtocolUrl],
                minzoom: 0,
                maxzoom: 14
            },
            osm: {
              type: "raster",
              tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
              tileSize: 256,
              attribution: 'Â© OpenStreetMap'
            },
            dem: {
              type: "raster-dem",
              encoding: "terrarium",
              tiles: [demSource.sharedDemProtocolUrl],
              maxzoom: 13,
              tileSize: 256,
            },
            contours: {
              type: "vector",
              tiles: [
                demSource.contourProtocolUrl({
                  multiplier: 1,
                  thresholds: {
                    11: [200, 1000],
                    12: [100, 500],
                    13: [50, 200],
                    14: [20, 100],
                  },
                  elevationKey: "ele",
                  levelKey: "level",
                  contourLayer: "contours",
                }),
              ],
              maxzoom: 15,
            },
          },
          layers: [
            {
              id: "osm",
              type: "raster",
              source: "osm",
              paint: { "raster-opacity": 0.6 },
              layout: {"visibility": "visible"}
            },
            {
                id: "nature_glacier",
                source: "mtk",
                "source-layer": "natural",
                type: "fill",
                filter: ["==", ["get", "type"], "ice"],
                minzoom: 4,
                maxzoom: 22,
                layout: {"visibility": "visible"},
                paint: {
                    "fill-color": "hsla(210, 50%, 80%, 0.5)"
                }
            },
            {
                id: "nature_rock",
                source: "mtk",
                "source-layer": "natural",
                type: "fill",
                filter: ["==", ["get", "type"], "rock"],
                minzoom: 4,
                maxzoom: 22,
                layout: {"visibility": "visible"},
                paint: {
                    "fill-color": "hsla(0, 10%, 80%, 0.5)"
                }
            },
            {
              id: "hills",
              type: "hillshade",
              source: "dem",
              paint: { 
                "hillshade-exaggeration": 0.2,
                "hillshade-shadow-color": "#000000"
              },
              layout: {"visibility": "visible"}
            },
            // Normal terrain contours (brown)
            {
              id: "contours-normal",
              type: "line",
              source: "contours",
              "source-layer": "contours",
              filter: ["==", ["get", "terrain_type"], "normal"],
              paint: {
                "line-color": "hsl(36, 40%, 50%)",
                "line-width": ["match", ["get", "level"], 1, 2, 1],
              },
            },
            // Glacier contours (blue)
            {
              id: "contours-glacier",
              type: "line",
              source: "contours",
              "source-layer": "contours",
              filter: ["==", ["get", "terrain_type"], "glacier"],
              paint: {
                "line-color": "hsl(211, 83%, 78%)",
                "line-width": ["match", ["get", "level"], 1, 2, 1],
              },
            },
            // Rock/scree contours (gray)
            {
              id: "contours-rock",
              type: "line",
              source: "contours",
              "source-layer": "contours",
              filter: ["==", ["get", "terrain_type"], "rock"],
              paint: {
                "line-color": "hsl(0, 0%, 61%)",
                "line-width": ["match", ["get", "level"], 1, 2, 1],
              },
            },
            // Contour labels
            {
              id: "contour-labels",
              type: "symbol",
              source: "contours",
              "source-layer": "contours",
              filter: [">", ["get", "level"], 0],
              minzoom: 11,
              paint: {
                "text-halo-color": "white",
                "text-halo-width": 1.5,
                "text-color": [
                  "match",
                  ["get", "terrain_type"],
                  "glacier", "#4A90E2",
                  "rock", "#696969",
                  "#8B4513"
                ],
              },
              layout: {
                "symbol-placement": "line",
                "text-size": 11,
                "text-field": ["concat", ["get", "ele"], "m"],
                "text-font": ["Noto Sans Bold"],
              },
            },
          ],
        },
      });
      
      // Add tile boundary visualization
      map.on('load', () => {
        console.log('Map loaded!');
        map.showTileBoundaries = true;
      });
      
      map.addControl(new maplibregl.NavigationControl());
      map.addControl(new maplibregl.ScaleControl({ maxWidth: 200, unit: 'metric' }));
      
      map.on('error', (e) => {
        console.error('Map error:', e);
      });
      
      // Log features for debugging
      map.on('idle', () => {
        const features = map.queryRenderedFeatures({ layers: ['contours-normal', 'contours-glacier', 'contours-rock'] });
        const byType = features.reduce((acc, f) => {
          const type = f.properties.terrain_type || 'unknown';
          acc[type] = (acc[type] || 0) + 1;
          return acc;
        }, {});
        console.log('Rendered contour features by terrain type:', byType);
      });
    </script>
  </body>
</html>
